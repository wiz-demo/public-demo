name: Wiz CLI Multi-Tenant Directory Scan

on:
  workflow_dispatch:
    inputs:
      tenant:
        description: 'Tenant to scan (leave empty to scan both)'
        required: false
        type: choice
        options:
        - advanced
        - stgadvanced
      wizcli_version:
        description: 'Version of Wiz CLI to use for scanning'
        required: true
        default: '1.10.0'
  push:
    branches:
      - main
      - staging
      - develop
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 3 */7 * *"

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  WizCLI-Dir-Scan:
    runs-on: ubuntu-latest
    env:
      WIZCLI_URL: https://downloads.wiz.io/experimental/v1/wizcli/latest/wizcli-linux-amd64
    strategy:
      fail-fast: false
      matrix:
        tenant: [advanced, stgadvanced]
        include:
          - tenant: stgadvanced
            deploy_env: demo
            op_item: tenant_stgadvanced-wizcli-sa
          - tenant: advanced
            deploy_env: demo
            op_item: tenant_advanced-wizcli-sa

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Configure 1Password Service Account
        uses: 1password/load-secrets-action/configure@581a835fb51b8e7ec56b71cf2ffddd7e68bb25e0
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Load Environment Secrets
        uses: 1password/load-secrets-action@581a835fb51b8e7ec56b71cf2ffddd7e68bb25e0
        with:
          export-env: true
        env:
          WIZCLI_URL: op://wiz-demo/${{ matrix.op_item }}/wizcliUrl
          WIZ_CLIENT_ID: op://wiz-demo/${{ matrix.op_item }}/username
          WIZ_CLIENT_SECRET: op://wiz-demo/${{ matrix.op_item }}/password

      - name: Get Wiz CLI SHA256
        id: get-sha256
        run: |
          echo "Fetching Wiz CLI SHA256..."
          WIZCLI_SHA256=$(curl -s ${{ env.WIZCLI_URL }}-sha256)
          echo "Wiz CLI SHA256: $WIZCLI_SHA256"
          echo "sha256=$WIZCLI_SHA256" >> $GITHUB_OUTPUT

      - name: Cache Wiz CLI Binary
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb  # v5.0.1
        with:
          path: ~/.wiz/wizcli
          key: ${{ runner.os }}-wizcli-${{ steps.get-sha256.outputs.sha256 }}
          restore-keys: |
            ${{ runner.os }}-wizcli-

      - name: Restore Wiz configuration and rules cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb  # v5.0.1
        with:
          path: ~/.wiz/${{ (matrix.deploy_env == '' || matrix.deploy_env == 'app') && 'clusterFilesCache' || format('{0}_clusterFilesCache', matrix.deploy_env) }}
          key: ${{ runner.os }}-wiz-config-${{ matrix.deploy_env || 'default' }}-${{ matrix.tenant }}
          restore-keys: |
            ${{ runner.os }}-wiz-config-${{ matrix.deploy_env || 'default' }}-${{ matrix.tenant }}
            ${{ runner.os }}-wiz-config-${{ matrix.deploy_env || 'default' }}-
            ${{ runner.os }}-wiz-config-

      - name: Install Wiz CLI
        if: success() || (failure() && matrix.deploy_env == 'develop')
        run: |
          if [ ! -f ~/.wiz/wizcli ]; then
            echo "Downloading Wiz CLI..."
            mkdir -p ~/.wiz
            curl -o ~/.wiz/wizcli ${{ env.WIZCLI_URL }} && chmod +x ~/.wiz/wizcli
            echo "Downloaded Wiz CLI with SHA256: ${{ steps.get-sha256.outputs.sha256 }}"
          else
            echo "Using cached Wiz CLI with SHA256: ${{ steps.get-sha256.outputs.sha256 }}"
          fi
          echo "WIZCLI_PATH=$HOME/.wiz/wizcli" >> $GITHUB_ENV

      - name: Run Wiz Security Scan
        run: |
          sudo -E ${{ env.WIZCLI_PATH }} scan dir "." \
          --name "${{ github.repository }}-${{ matrix.tenant }}-${{ github.run_id }}" --tag github_action_run_id=${{ github.run_id }} \
          --tag tenant=${{ matrix.tenant }} --tag deploy_env=${{ matrix.deploy_env }} --sarif-output-file "${{ matrix.tenant }}-${{ github.run_id }}.json" --sbom-format spdx-json \
          --sbom-output-file "${{ matrix.tenant }}-${{ github.run_id }}-sbom.json"
        env:
          WIZ_ENV: ${{ matrix.deploy_env }}
        continue-on-error: true

      - name: Get Cluster Files Cache SHA256
        if: always()
        id: get-cluster-sha256
        run: |
          echo "Checking for cluster files cache after scan..."
          # Determine cache path based on deploy_env
          if [ -z "${{ matrix.deploy_env }}" ] || [ "${{ matrix.deploy_env }}" = "app" ]; then
            CACHE_DIR="$HOME/.wiz/clusterFilesCache"
          else
            CACHE_DIR="$HOME/.wiz/${{ matrix.deploy_env }}_clusterFilesCache"
          fi
          echo "Expected cache directory: $CACHE_DIR"

          if [ -d "$CACHE_DIR" ] && [ -f "$CACHE_DIR/clusterFiles.tar.gz" ]; then
            CLUSTER_SHA256=$(sha256sum "$CACHE_DIR/clusterFiles.tar.gz" | cut -d' ' -f1)
            echo "Cluster files SHA256: $CLUSTER_SHA256"
            echo "sha256=$CLUSTER_SHA256" >> $GITHUB_OUTPUT
            echo "cache_exists=true" >> $GITHUB_OUTPUT
          else
            echo "No cluster files cache found after scan"
            echo "sha256=no-cache" >> $GITHUB_OUTPUT
            echo "cache_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Cache Wiz configuration and rules
        if: always() && steps.get-cluster-sha256.outputs.cache_exists == 'true'
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb  # v5.0.1
        with:
          path: ~/.wiz/${{ matrix.deploy_env }}_clusterFilesCache
          key: ${{ runner.os }}-wiz-config-${{ matrix.deploy_env }}-${{ matrix.tenant }}
          restore-keys: |
            ${{ runner.os }}-wiz-config-${{ matrix.deploy_env }}-${{ matrix.tenant }}
            ${{ runner.os }}-wiz-config-${{ matrix.deploy_env }}-
            ${{ runner.os }}-wiz-config-

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7  # v4
        with:
          sarif_file: "${{ matrix.tenant }}-${{ github.run_id }}.json"
          category: wiz-${{ matrix.tenant }}
        continue-on-error: true

      - name: Upload SBOM file
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 #v5.0.0
        with:
          name: sbom-${{ matrix.tenant }}-${{ github.run_id }}
          path: "${{ matrix.tenant }}-${{ github.run_id }}-sbom.json"
          retention-days: 30
        continue-on-error: true

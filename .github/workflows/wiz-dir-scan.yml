name: Wiz CLI Multi-Tenant Directory Scan

on:
  workflow_dispatch:
    inputs:
      wizcli_version:
        description: 'Version of Wiz CLI to use for scanning'
        required: true
        default: '1.10.0'
      tenants:
        description: 'Comma-separated list of tenants to scan (e.g., staging,demo,production)'
        required: false
        default: 'staging,demo'
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 3 */7 * *"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  Wiz-Multi-Tenant-Scan:
    runs-on: ubuntu-latest
    env:
      WIZCLI_URL: https://downloads.wiz.io/experimental/v1/wizcli/latest/wizcli-linux-amd64
    strategy:
      fail-fast: false
      matrix:
        tenant: [staging, demo]
        include:
          - tenant: staging
            deploy_env: demo
            op_item: tenant_adv-stg-wizcli-sa
          - tenant: demo
            deploy_env: demo
            op_item: tenant_adv-prod-wizcli-sa

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Configure 1Password Service Account
        uses: 1password/load-secrets-action/configure@581a835fb51b8e7ec56b71cf2ffddd7e68bb25e0
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Load Environment Secrets
        uses: 1password/load-secrets-action@581a835fb51b8e7ec56b71cf2ffddd7e68bb25e0
        with:
          export-env: true
        env:
          WIZ_CLIENT_ID: op://wiz-demo/${{ matrix.op_item }}/username
          WIZ_CLIENT_SECRET: op://wiz-demo/${{ matrix.op_item }}/password

      - name: Get Wiz CLI SHA256
        id: get-sha256
        run: |
          echo "Fetching Wiz CLI SHA256..."
          WIZCLI_SHA256=$(curl -s https://downloads.wiz.io/experimental/v1/wizcli/latest/wizcli-linux-amd64-sha256)
          echo "Wiz CLI SHA256: $WIZCLI_SHA256"
          echo "sha256=$WIZCLI_SHA256" >> $GITHUB_OUTPUT

      - name: Cache Wiz CLI Binary
        uses: actions/cache@v4
        with:
          path: ~/.wiz/wizcli
          key: ${{ runner.os }}-wizcli-${{ steps.get-sha256.outputs.sha256 }}
          restore-keys: |
            ${{ runner.os }}-wizcli-

      - name: Install Wiz CLI
        run: |
          if [ ! -f ~/.wiz/wizcli ]; then
            echo "Downloading Wiz CLI..."
            mkdir -p ~/.wiz
            curl -o ~/.wiz/wizcli ${{ env.WIZCLI_URL }} && chmod +x ~/.wiz/wizcli
            echo "Downloaded Wiz CLI with SHA256: ${{ steps.get-sha256.outputs.sha256 }}"
          else
            echo "Using cached Wiz CLI with SHA256: ${{ steps.get-sha256.outputs.sha256 }}"
          fi
          echo "WIZCLI_PATH=~/.wiz/wizcli" >> $GITHUB_ENV

      - name: Get Cluster Files Cache SHA256
        id: get-cluster-sha256
        run: |
          echo "Checking for existing cluster files cache..."
          CACHE_DIR="$HOME/.wiz/${{ matrix.deploy_env }}_clusterFilesCache"
          if [ -f "$CACHE_DIR/clusterFiles.tar.gz" ]; then
            CLUSTER_SHA256=$(sha256sum "$CACHE_DIR/clusterFiles.tar.gz" | cut -d' ' -f1)
            echo "Existing cluster files SHA256: $CLUSTER_SHA256"
            echo "sha256=$CLUSTER_SHA256" >> $GITHUB_OUTPUT
          else
            echo "No existing cluster files cache found"
            echo "sha256=no-cache" >> $GITHUB_OUTPUT
          fi

      - name: Cache Wiz configuration and rules
        uses: actions/cache@v4
        with:
          path: ~/.wiz/${{ matrix.deploy_env }}_clusterFiles/clusterFiles.tar.gz
          key: ${{ runner.os }}-wiz-config-${{ steps.get-cluster-sha256.outputs.sha256 }}
          restore-keys: |
            ${{ runner.os }}-wiz-config-

      - name: Run Wiz Security Scan
        run: |
          sudo -E ${{ env.WIZCLI_PATH }} scan dir "." \
          --name "${{ github.repository }}-${{ matrix.tenant }}-${{ github.run_id }}" --tag github_action_run_id=${{ github.run_id }} \
          --tag tenant=${{ matrix.tenant }} --tag deploy_env=${{ matrix.deploy_env }} --sarif-output-file "${{ matrix.tenant }}-${{ github.run_id }}.json" --sbom-format spdx-json \
          --sbom-output-file "${{ matrix.tenant }}-${{ github.run_id }}-sbom.json"
        env:
          WIZ_ENV: ${{ matrix.deploy_env }}
        continue-on-error: true

      - name: Check SARIF file exists
        if: always()
        run: |
          SARIF_FILE="${{ matrix.tenant }}-${{ github.run_id }}.json"
          if [ -f "$SARIF_FILE" ]; then
            echo "SARIF file exists: $SARIF_FILE"
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
          else
            echo "SARIF file not found: $SARIF_FILE"
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
          fi
        id: check-sarif

      - name: Check cluster files cache exists
        if: always()
        run: |
          CACHE_DIR="$HOME/.wiz/${{ matrix.deploy_env }}_clusterFilesCache"
          if [ -f "$CACHE_DIR/clusterFiles.tar.gz" ]; then
            echo "Cluster files cache exists: $CACHE_DIR"
            echo "cluster_files_cache_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Cluster files cache not found: $CACHE_DIR"
            echo "cluster_files_cache_exists=false" >> $GITHUB_OUTPUT
          fi
        id: check-cluster-files-cache

      - name: Upload SARIF file
        if: always() && steps.check-sarif.outputs.sarif_exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "${{ matrix.tenant }}-${{ github.run_id }}.json"
          category: wiz-${{ matrix.tenant }}
        continue-on-error: true

      - name: Upload SBOM file
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.tenant }}-${{ github.run_id }}
          path: "${{ matrix.tenant }}-${{ github.run_id }}-sbom.json"
          retention-days: 30
        continue-on-error: true
